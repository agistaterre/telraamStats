---
title: "Visualize and analyse traffic"
output: rmarkdown::html_vignette
description:
  Learn how to visualize and analyse traffic data from Telraam cameras.
vignette: >
  %\VignetteIndexEntry{Visualize and analyse traffic}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)

knitr::knit_engines$set(yml = function(options) {
})

knitr::opts_chunk$set(eval = FALSE)
```

## Introduction

This vignette illustrates the potential visualizations (and the ensuing analysis) of traffic data from Telraam sensors provided by the package.

Before we go on, we'll attach the packages we use.

```{r setup, eval = TRUE}
library(telraamStats)
```

We will also load the data: here, we will use the dataset attached to the package, but you can certainly replicate these visualizations and analyses using data from your own sensors. For more information on data retrieval, you can refer to the dedicated vignette (`vignette("data-details")`).

Included dataset is lazily loaded with the telraamStats package. If you have already called `library(telraamStats)`, the dataset is already attached and you can call it directly :

```{r, eval=FALSE, results='asis'}
head(traffic)
```

```{r, echo=FALSE, eval=TRUE}
knitr::kable(head(traffic))
```

## Period availability for your segments

Road segment-specific sensors do not operate continuously; they are limited by daylight duration and may also face other external issues (being unplugged, falling, software problems, etc.). The data collected during a period may not be continuous and could have interruptions ranging from an hour to several days.

To visualize traffic, it is important to be aware of the operating periods of the sensors being analyzed, as well as the quality of their data. The data reliability is provided through the uptime indicator. Uptime, ranging from 0 to 1, corresponds to the percentage of time during which the camera is actively counting passages. Following Telraam's recommendations, here an uptime lower than 0.5 is considered associated with poor-quality data.

The graphical representation below, obtained using the `gg_availability()` function, provides an overview of data availability and quality for different sensors over the entire period. It illustrates the daily average uptime evolution: the higher this value, the better the data quality for that sensor on the respective day. Its purpose is to assist you in selecting study periods.

```{r, eval=TRUE}
plot(
  gg_availability(traffic)
)
```

On this graph, for example, we can observe through black time slots that the camera on the segment 'ParisArcEnCiel-05' did not report any data at the end of June 2022 and at the end of the year 2022. We can also notice that the average uptime is higher during the summer period. This illustrates the fact that the duration of daylight, and therefore the possible filming period, is longer in summer.

## Traffic evolution

Once you have identified the specific period you want to analyze, you may want to observe the evolution of traffic trends over time. `gg_traffic_evolution()` enables the representation of traffic for a particular period, aggregated for all or some segments, for a specific direction, or aggregated for both, and aggregated for all transportation modes or for selected ones.

Without specifying any options, you can view the traffic evolution of cars and heavy vehicles for all segments over the entire period. By default, a smoothing curve (based on a GAM model with cubic spline) is used to represent the trend.

```{r, eval=TRUE}
plot(
  gg_traffic_evolution(traffic)
)
```


You can specify a date range, one or more segments, different transportation modes or directions and choose whether you want a smoothing curve or not. By default, the aggregation is done by day, but you can obtain more precise information by setting the `agg_day` parameter to `FALSE` to aggregate by hour.


```{r, eval=TRUE}
plot(
  gg_traffic_evolution(traffic,
                       date_range = c('2022-01-01','2022-03-01'),
                       segment = c(9000001844),
                       mode = c('car','pedestrian'),
                       direction = c('lft'),
                       smoothed = FALSE,
                       agg_day = FALSE)
)
```


## Average traffic

### Average traffic per weekday

The traffic varies according to the days of the week, which can serve as an analytical window to understand territorial mobility. The gg_traffic_avg function allows to examine the average behavior per day of the week. It can be used globally or more specifically (over a specific period, on a segment or set of segments, for a specific direction, for a particular transportation mode).

```{r, eval=TRUE}
plot(
  gg_traffic_avg(traffic)
)
```

```{r, eval=TRUE}
plot(
  gg_traffic_avg(traffic,
                       date_range = c('2022-01-01','2022-03-01'),
                       segment = c("RteVitre-06"),
                       mode = c('car'),
                       direction = c('rgt'))
)
```

### Average traffic per segment

The same function can be used to calculate the average traffic per segment and compare segments with each other.

```{r, eval=TRUE}
plot(
  gg_traffic_avg(traffic, aggregated_by = "segment_name")
)
```
Similarly to before, it is possible to specify a period, a direction of travel, a mode of transportation, or here a day of the week.

```{r, eval=TRUE}
plot(
  gg_traffic_avg(traffic, 
                 aggregated_by = "segment_name",
                 weekday = c('dimanche'),
                 mode = c('car'),
                 direction = c('rgt'))
)
```

### Detail average traffic
